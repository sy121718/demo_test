# 权限验证系统使用指南

## 一、系统概述

基于权限标识表的自动化权限验证系统，通过中间件自动验证用户是否拥有访问API的权限。

### 核心组件

1. **PermissionMiddleware** - 权限验证中间件（自动化验证）
2. **PermissionService** - 权限验证业务服务
3. **SysPermissionDictModel** - 权限标识表模型
4. **JwtService** - JWT Token验证服务
5. **SysUserSessionsModel** - 用户会话管理

## 二、工作原理

```
请求 → SignMiddleware → PermissionMiddleware → Controller
              ↓               ↓
         签名验证        权限验证
```

### 验证流程

1. **路由匹配** - 根据请求路径和HTTP方法查询权限标识表
2. **接口检查** - 检查接口是否存在、是否启用
3. **公开接口** - 如果是公开接口（is_public=1），直接放行
4. **跳过列表** - 检查是否在配置的跳过列表中
5. **身份验证** - 验证JWT Token和用户ID
6. **权限查询** - 通过用户角色关联查询权限
7. **权限判断** - 有权限放行，无权限返回403

## 三、配置说明

### 3.1 中间件配置 (`app/middleware.php`)

```php
return [
    // API签名验证中间件
    \app\middleware\SignMiddleware::class,
    
    // 权限验证中间件（自动化权限验证）
    \app\middleware\PermissionMiddleware::class,
];
```

### 3.2 权限配置 (`config/permission.php`)

```php
return [
    // 跳过权限验证的路由列表
    'skip_routes' => [
        '/api/auth/login',          // 登录接口
        '/api/auth/register',       // 注册接口  
        '/api/public/*',            // 公开API
    ],
    
    // 是否启用权限验证
    'enable_permission_check' => true,
];
```

## 四、权限标识表设计

### 表结构 (`sys_permission_dict`)

| 字段 | 类型 | 说明 |
|------|------|------|
| perm_code | varchar(100) | 权限标识（如：user:add） |
| api_path | varchar(200) | API路径（如：/api/user/add） |
| http_method | varchar(10) | HTTP方法（GET/POST/PUT/DELETE） |
| is_public | tinyint | 是否公开接口：0需要认证，1公开访问 |
| status | tinyint | 状态：1启用、0禁用 |

### 示例数据

```sql
INSERT INTO sys_permission_dict (perm_name, perm_code, api_path, http_method, is_public, status) VALUES
('用户列表', 'user:list', '/api/user/list', 'GET', 0, 1),
('用户新增', 'user:add', '/api/user/add', 'POST', 0, 1),
('系统信息', 'system:info', '/api/system/info', 'GET', 1, 1);  -- 公开接口
```

## 五、权限关联关系

```
用户 → 用户角色关联 → 角色 → 角色菜单关联 → 菜单 → 权限标识
sys_user → sys_user_role → sys_role → sys_role_menu → sys_menus → sys_permission_dict
```

### 关联查询SQL

```sql
-- 查询用户是否拥有某个权限
SELECT COUNT(*) FROM sys_permission_dict spd
JOIN sys_menus sm ON spd.id = sm.perm_dict_id  
JOIN sys_role_menu srm ON sm.id = srm.menu_id
JOIN sys_user_role sur ON srm.role_id = sur.role_id
WHERE sur.user_id = ? 
  AND spd.api_path = ? 
  AND spd.http_method = ?
  AND spd.status = 1
  AND sm.status = 1
```

## 六、前端请求格式

### 请求头设置

```javascript
headers: {
    'Authorization': 'Bearer ' + jwt_token,     // JWT Token
    'User-ID': user_id,                         // 用户ID
    'X-Timestamp': Math.floor(Date.now() / 1000), // 时间戳
    'X-Nonce': generateRandomString(16),        // 随机字符串
    'X-Sign': generateSign(params, api_secret), // API签名
    'Content-Type': 'application/json'
}
```

## 七、错误码说明

| HTTP状态码 | 说明 | 触发条件 |
|------------|------|----------|
| 400 | 请求参数错误 | 缺少User-ID或格式错误 |
| 401 | 认证失败 | Token无效、过期或用户被禁用 |
| 403 | 权限不足 | 用户没有访问该API的权限 |
| 404 | 接口不存在 | API路径在权限表中不存在 |
| 503 | 服务不可用 | 接口被禁用 |

## 八、日志记录

### 权限验证日志

系统会自动记录权限验证的关键信息：

```php
// 验证成功日志
Log::info('权限验证', [
    'user_id' => 123,
    'api_path' => '/api/user/list',
    'http_method' => 'GET',
    'result' => true,
    'permission_code' => 'user:list',
    'ip' => '192.168.1.100'
]);

// 验证失败日志
Log::info('权限验证', [
    'user_id' => 123,
    'api_path' => '/api/user/delete',
    'http_method' => 'DELETE',
    'result' => false,
    'error' => '权限不足，无法访问该资源',
    'user_roles' => ['普通用户'],
    'ip' => '192.168.1.100'
]);
```

## 九、使用优势

### 9.1 自动化验证
- 中间件自动拦截所有请求
- 无需在每个控制器中手动验证权限
- 统一的权限验证逻辑

### 9.2 灵活配置
- 通过配置文件设置跳过的路由
- 支持公开接口标记（is_public=1）
- 可以动态启用/禁用权限验证

### 9.3 完整的安全体系
- JWT Token + 会话双重验证
- API签名防篡改
- 设备类型限制
- 详细的操作日志

### 9.4 高性能
- 基于数据库索引的快速查询
- 可扩展的缓存机制
- 批量权限检查支持

## 十、开发建议

### 10.1 权限设计原则
- 权限标识命名规范：`模块:操作`（如：user:add）
- 一个API对应一个权限标识
- 公开接口统一设置 is_public=1

### 10.2 角色设计
- 按业务模块划分角色
- 遵循最小权限原则
- 支持角色继承和组合

### 10.3 性能优化
- 为权限查询相关字段建立索引
- 考虑使用Redis缓存热点权限数据
- 定期清理过期的会话记录 